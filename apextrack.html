<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Track Apex - Prise de Notes Circuit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            touch-action: none;
            background-color: #111827; /* bg-gray-900 */
        }
        .header-title {
            font-family: 'Orbitron', sans-serif;
        }
        .touch-button {
            @apply text-center p-3 border border-gray-500 rounded-lg shadow-sm cursor-pointer transition-all duration-150 ease-in-out;
        }
        .turn-marker, .ref-marker {
            position: absolute;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
            cursor: grab;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transform: translate(-50%, -50%);
            user-select: none;
            transition: opacity 0.3s ease-in-out, transform 0.2s ease-in-out;
        }
        .turn-marker {
             background-color: rgba(107, 114, 128, 0.9); /* gray-500 */
             border-radius: 50%;
             font-size: 16px;
        }
        .ref-marker {
            border-radius: 0.5rem; /* rounded-lg */
            font-size: 18px;
        }
        .turn-marker.selected {
            background-color: rgba(59, 130, 246, 1); /* blue-600 */
            transform: translate(-50%, -50%) scale(1.2);
            z-index: 10;
        }
        #placing-indicator, #loading-overlay {
            position: fixed;
            z-index: 1000;
        }
        #loading-overlay {
            inset: 0;
            background-color: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(4px);
        }
        #map-image-wrapper {
            position: relative;
            max-width: 100%;
            max-height: 100%;
        }
        #map-image {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        #marker-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #note-tooltip {
            position: absolute;
            transform: translate(-50%, -110%);
            background-color: rgba(17, 24, 39, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #4b5563;
            font-size: 14px;
            pointer-events: none;
            z-index: 20;
            max-width: 200px;
            word-wrap: break-word;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen overflow-hidden flex flex-col">

    <div id="loading-overlay" class="flex flex-col items-center justify-center">
        <i class="fa-solid fa-spinner fa-spin fa-3x text-blue-400"></i>
        <p class="mt-4 text-lg font-semibold">Connexion à Firebase...</p>
    </div>

    <!-- Header -->
    <header class="bg-gray-800 shadow-lg p-3 flex justify-between items-center z-20">
        <h1 class="header-title text-xl font-bold text-white tracking-wider"><i class="fa-solid fa-route mr-2"></i>TRACK APEX</h1>
        <div class="flex items-center space-x-4">
            <button id="summary-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" disabled><i class="fa-solid fa-file-alt mr-2"></i>Résumé</button>
            <div class="flex items-center">
                <span class="mr-2 text-sm font-medium text-gray-300">Vue Globale</span>
                <label for="global-view-toggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="global-view-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            <span id="user-id-display" class="text-xs text-gray-400"></span>
            <button id="new-circuit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" disabled><i class="fa-solid fa-plus mr-2"></i>Nouveau Circuit</button>
            <select id="circuit-selector" class="bg-gray-700 border border-gray-600 rounded-lg p-2 text-white" disabled>
                <option value="">Chargement...</option>
            </select>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-4 p-4 overflow-hidden">
        
        <div id="map-container" class="md:col-span-2 bg-gray-800 rounded-lg shadow-inner relative overflow-hidden flex items-center justify-center">
            <div id="map-image-container" class="w-full h-full flex items-center justify-center"></div>
            <div id="map-placeholder" class="text-center text-gray-400 p-4">
                <i class="fa-solid fa-map-location-dot fa-4x mb-4"></i>
                <h2 class="text-2xl font-bold">Bienvenue sur Track Apex</h2>
                <p class="mt-2">Créez un "Nouveau Circuit" pour commencer ou sélectionnez-en un existant.</p>
            </div>
            <div id="placing-indicator" class="hidden fixed top-20 left-1/2 -translate-x-1/2 bg-yellow-400 text-black font-bold p-2 rounded-lg shadow-xl">
                <i class="fa-solid fa-crosshairs fa-spin mr-2"></i> Touchez la carte pour placer le repère
            </div>
            <div id="note-tooltip" class="hidden"></div>
        </div>

        <div id="data-panel" class="bg-gray-800 rounded-lg shadow-inner p-4 overflow-y-auto flex flex-col space-y-4">
            <div id="data-panel-placeholder" class="flex-grow flex flex-col items-center justify-center text-gray-500 text-center transition-all">
                <i class="fa-solid fa-arrow-left fa-3x mb-4"></i>
                <h3 class="text-xl font-semibold">Aucun virage sélectionné</h3>
                <p class="mt-1">Touchez un numéro de virage sur la carte pour afficher ses données.</p>
            </div>
            
            <div id="turn-data-content" class="hidden flex-grow flex flex-col space-y-4">
                <div class="flex justify-between items-center">
                    <button id="prev-turn-btn" class="p-3 bg-gray-700 rounded-lg hover:bg-gray-600"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2 id="turn-title" class="text-2xl font-bold text-center">Virage 1</h2>
                    <button id="next-turn-btn" class="p-3 bg-gray-700 rounded-lg hover:bg-gray-600"><i class="fa-solid fa-chevron-right"></i></button>
                </div>

                <div id="toolbox" class="bg-gray-700 p-3 rounded-lg">
                    <h5 class="font-bold mb-3 text-center">Ajouter un Repère</h5>
                    <div class="grid grid-cols-2 gap-3">
                        <button data-reftype="braking" class="add-ref-btn w-full touch-button bg-red-600/50 hover:bg-red-500/50"><i class="fa-solid fa-hand-paper mr-2"></i>Freinage</button>
                        <button data-reftype="gear" class="add-ref-btn w-full touch-button bg-cyan-600/50 hover:bg-cyan-500/50"><i class="fa-solid fa-gear mr-2"></i>Rapport</button>
                        <button data-reftype="throttleOn" class="add-ref-btn w-full touch-button bg-teal-500/50 hover:bg-teal-400/50"><i class="fa-solid fa-fire-flame-curved mr-2"></i>Remise Gaz</button>
                        <button data-reftype="turnIn" class="add-ref-btn w-full touch-button bg-orange-500/50 hover:bg-orange-400/50"><i class="fa-solid fa-arrow-down mr-2"></i>Déclenchement</button>
                        <button data-reftype="apex" class="add-ref-btn w-full touch-button bg-yellow-500/50 hover:bg-yellow-400/50"><i class="fa-solid fa-crosshairs mr-2"></i>Corde</button>
                        <button data-reftype="exit" class="add-ref-btn w-full touch-button bg-green-600/50 hover:bg-green-500/50"><i class="fa-solid fa-rocket mr-2"></i>Sortie</button>
                    </div>
                </div>

                <div>
                    <h4 class="font-semibold mb-2"><i class="fa-solid fa-pencil mr-2"></i>Notes & Ressenti (Virage)</h4>
                    <textarea id="general-notes" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400" placeholder="Ex: Attention à la bosse en entrée, grip précaire..."></textarea>
                </div>
                 <div class="flex-grow"></div>
                <button id="delete-turn-btn" class="w-full mt-4 bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fa-solid fa-trash mr-2"></i>Supprimer tous les repères de ce virage</button>

            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container">
        <div id="new-circuit-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden">
            <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-lg m-4">
                <h2 id="new-circuit-modal-title" class="text-2xl font-bold mb-4">Ajouter un Nouveau Circuit</h2>
                <div class="space-y-4">
                    <div>
                        <label for="circuit-name" class="block mb-1 font-semibold">Nom du Circuit</label>
                        <input type="text" id="circuit-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white" placeholder="Ex: Le Mans Bugatti">
                    </div>
                    <div>
                        <label for="circuit-image" class="block mb-1 font-semibold">Image du Plan du Circuit</label>
                        <input type="file" id="circuit-image" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700">
                    </div>
                    <div id="modal-turn-def" class="hidden">
                        <p class="text-yellow-400 font-semibold"><i class="fa-solid fa-hand-pointer mr-2"></i>Touchez l'image pour définir les virages dans l'ordre.</p>
                        <div id="preview-container" class="mt-2 w-full h-64 bg-gray-900 rounded-lg relative overflow-hidden">
                            <img id="image-preview" src="" class="w-full h-full object-contain">
                            <div id="preview-dots-container" class="absolute top-0 left-0 w-full h-full"></div>
                        </div>
                        <p class="text-sm text-gray-400 mt-2">Virages définis : <span id="turn-count">0</span></p>
                    </div>
                </div>
                <div id="modal-error" class="text-red-400 text-sm h-5 mt-4 text-left"></div>
                <div class="mt-2 flex justify-end space-x-4">
                    <button id="modal-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Annuler</button>
                    <button id="modal-save" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Sauvegarder</button>
                </div>
            </div>
        </div>

        <div id="value-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden">
             <div id="value-modal-content" class="bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-md m-4">
                <h3 id="value-modal-title" class="text-xl font-bold mb-4 text-center"></h3>
                <div id="value-modal-options" class="space-y-3"></div>
                <div class="mt-4">
                    <label for="marker-notes" class="block text-sm font-medium text-gray-300 mb-1">Notes pour ce repère</label>
                    <textarea id="marker-notes" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400"></textarea>
                </div>
                <div class="flex justify-end mt-6">
                    <button id="value-modal-delete" class="text-red-400 hover:text-red-300 mr-auto font-semibold">Supprimer</button>
                    <button id="value-modal-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Annuler</button>
                </div>
            </div>
        </div>

        <div id="summary-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center hidden p-4">
             <div class="bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-3xl m-4 h-full max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-center header-title">Résumé du Circuit</h3>
                    <button id="summary-modal-close" class="p-2 -mr-2 rounded-full hover:bg-gray-700"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div id="summary-content" class="flex-grow overflow-y-auto pr-4 space-y-4"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, where, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBjNSWsvjBrrYhp4WbJ3eKTV8_xxJB13OU",
            authDomain: "apexnote-ae9c5.firebaseapp.com",
            projectId: "apexnote-ae9c5",
            storageBucket: "apexnote-ae9c5.firebasestorage.app",
            messagingSenderId: "142592305791",
            appId: "1:142592305791:web:f8d73d4383474441abed4a"
        };

        const MARKER_CONFIG = {
            braking: { name: 'Freinage', icon: 'fa-hand-paper', defaultColor: 'bg-gray-500', colors: { 'Léger': 'bg-yellow-500', 'Moyen': 'bg-orange-500', 'Fort': 'bg-red-600', 'Très Fort': 'bg-black' } },
            gear: { name: 'Rapport', icon: 'fa-gear', defaultColor: 'bg-cyan-600' },
            throttleOn: { name: 'Remise des Gaz', icon: 'fa-fire-flame-curved', defaultColor: 'bg-gray-500', values: ['Filet', 'Léger', 'Gros Gaz', 'À Fond'] },
            turnIn: { name: 'Déclenchement', icon: 'fa-arrow-down', defaultColor: 'bg-orange-500' },
            apex: { name: 'Corde', icon: 'fa-crosshairs', defaultColor: 'bg-yellow-500' },
            exit: { name: 'Sortie', icon: 'fa-rocket', defaultColor: 'bg-green-600' },
        };
        
        let app, auth, db, storage, userId = null;
        let currentCircuitId = null, currentCircuitData = null;
        let selectedTurnIndex = -1, allTurnsNotes = {};
        let placingData = null;
        let selectedRefType = null;
        let circuitsUnsubscribe = null, notesUnsubscribe = null;
        let draggingMarker = null;
        let isGlobalView = false;
        let DOMElements = {};

        document.addEventListener('DOMContentLoaded', () => {
            [...document.querySelectorAll('[id]')].forEach(e => {
                DOMElements[e.id.replace(/-(\w)/g, (m, p1) => p1.toUpperCase())] = e;
            });

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
            } catch (e) {
                DOMElements.loadingOverlay.innerHTML = `<p class="text-red-400">Erreur d'initialisation de Firebase.</p>`;
                return;
            }

            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    DOMElements.userIdDisplay.textContent = `UserID: ${userId.substring(0, 8)}...`;
                    DOMElements.newCircuitBtn.disabled = false;
                    DOMElements.circuitSelector.disabled = false;
                    loadUserCircuits();
                    DOMElements.loadingOverlay.style.display = 'none';
                } else {
                    signInAnonymously(auth).catch(err => DOMElements.loadingOverlay.innerHTML = `<p class="text-red-400">Erreur d'authentification.</p>`);
                }
            });

            initEventHandlers();
        });

        function loadUserCircuits() {
            if (circuitsUnsubscribe) circuitsUnsubscribe();
            const circuitsQuery = query(collection(db, "circuits"), where("userId", "==", userId));
            circuitsUnsubscribe = onSnapshot(circuitsQuery, (snapshot) => {
                const selectedValue = DOMElements.circuitSelector.value;
                DOMElements.circuitSelector.innerHTML = '<option value="">Sélectionnez un circuit</option>';
                snapshot.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = doc.data().name;
                    DOMElements.circuitSelector.appendChild(option);
                });
                if (currentCircuitId) DOMElements.circuitSelector.value = currentCircuitId;
            });
        }
        
        async function selectCircuit(circuitId) {
            if (!circuitId) { resetUI(); return; }
            currentCircuitId = circuitId;
            const circuitDoc = await getDoc(doc(db, "circuits", circuitId));
            if (circuitDoc.exists()) {
                currentCircuitData = circuitDoc.data();
                DOMElements.mapPlaceholder.style.display = 'none';
                DOMElements.dataPanelPlaceholder.style.display = 'flex';
                DOMElements.turnDataContent.style.display = 'none';
                DOMElements.summaryBtn.disabled = false;
                selectedTurnIndex = -1;
                listenForAllTurnNotes();
            } else { resetUI(); }
        }

        function listenForAllTurnNotes() {
            if (notesUnsubscribe) notesUnsubscribe();
            const notesQuery = query(collection(db, "notes"), where("circuitId", "==", currentCircuitId), where("userId", "==", userId));
            notesUnsubscribe = onSnapshot(notesQuery, (snapshot) => {
                allTurnsNotes = {};
                snapshot.forEach(doc => {
                    const noteData = doc.data();
                    allTurnsNotes[noteData.turnIndex] = noteData;
                });
                drawCircuitMap();
            });
        }

        async function selectTurn(index) {
            if (index < 0 || !currentCircuitData || index >= currentCircuitData.turns.length) return;
            selectedTurnIndex = index;
            DOMElements.turnTitle.textContent = `Virage ${index + 1}`;
            DOMElements.dataPanelPlaceholder.style.display = 'none';
            DOMElements.turnDataContent.style.display = 'block';
            updateTurnMarkersSelection();
            const currentTurnNotes = allTurnsNotes[selectedTurnIndex] || {
                circuitId: currentCircuitId, turnIndex: selectedTurnIndex, userId: userId
            };
            DOMElements.generalNotes.value = currentTurnNotes.generalNotes || '';
            drawAllReferenceMarkers();
        }

        async function saveTurnNotes(turnIndex, notes) {
            if (turnIndex === -1 || !currentCircuitId) return;
            const noteId = `${userId}_${currentCircuitId}_${turnIndex}`;
            await setDoc(doc(db, "notes", noteId), notes, { merge: true });
        }
        
        async function updateCircuitData() {
            if (!currentCircuitId) return;
            await updateDoc(doc(db, "circuits", currentCircuitId), { turns: currentCircuitData.turns });
        }

        function resetUI() {
            currentCircuitId = null; currentCircuitData = null; selectedTurnIndex = -1;
            DOMElements.mapImageContainer.style.backgroundImage = '';
            DOMElements.mapPlaceholder.style.display = 'flex';
            DOMElements.dataPanelPlaceholder.style.display = 'flex';
            DOMElements.turnDataContent.style.display = 'none';
            DOMElements.summaryBtn.disabled = true;
            DOMElements.mapImageContainer.innerHTML = '';
            if (circuitsUnsubscribe) circuitsUnsubscribe();
            if (notesUnsubscribe) notesUnsubscribe();
        }

        function drawCircuitMap() {
            DOMElements.mapImageContainer.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.id = 'map-image-wrapper';
            
            const img = document.createElement('img');
            img.id = 'map-image';
            img.src = currentCircuitData.imageUrl;
            
            const markerWrapper = document.createElement('div');
            markerWrapper.id = 'marker-wrapper';
            
            wrapper.append(img, markerWrapper);
            DOMElements.mapImageContainer.append(wrapper);

            img.onload = () => {
                const aspectRatio = img.naturalWidth / img.naturalHeight;
                wrapper.style.aspectRatio = aspectRatio;
                drawAllMarkers();
            }
            
            const resizeObserver = new ResizeObserver(() => {
                const renderedImg = document.getElementById('map-image');
                if(renderedImg) {
                    const { width, height, top, left } = renderedImg.getBoundingClientRect();
                    const wrapper = document.getElementById('marker-wrapper');
                    const containerRect = DOMElements.mapImageContainer.getBoundingClientRect();
                    wrapper.style.width = `${width}px`;
                    wrapper.style.height = `${height}px`;
                    wrapper.style.top = `${top - containerRect.top}px`;
                    wrapper.style.left = `${left - containerRect.left}px`;
                }
            });
            resizeObserver.observe(DOMElements.mapImageContainer);
        }
        
        function drawAllMarkers() {
            const wrapper = DOMElements.mapImageContainer.querySelector('#marker-wrapper');
            if(!wrapper) return;
            wrapper.innerHTML = ''; // Clear all markers before redrawing
            currentCircuitData.turns.forEach((turn, index) => {
                createTurnMarker(turn, index);
            });
            drawAllReferenceMarkers();
        }
        
        function createTurnMarker(turn, index) {
            const marker = document.createElement('div');
            marker.className = 'turn-marker';
            marker.textContent = index + 1;
            marker.style.left = `${turn.x}%`;
            marker.style.top = `${turn.y}%`;
            marker.dataset.index = index;
            marker.dataset.type = 'turn';
            marker.onclick = (e) => { e.stopPropagation(); selectTurn(index); };
            marker.onmousedown = (e) => { e.stopPropagation(); startDrag(e, marker); };
            marker.ontouchstart = (e) => { e.stopPropagation(); startDrag(e, marker); };
            DOMElements.mapImageContainer.querySelector('#marker-wrapper').appendChild(marker);
        }

        function updateTurnMarkersSelection() {
            DOMElements.mapImageContainer.querySelectorAll('.turn-marker').forEach(marker => {
                marker.classList.toggle('selected', parseInt(marker.dataset.index) === selectedTurnIndex);
            });
        }

        function drawAllReferenceMarkers() {
            const wrapper = DOMElements.mapImageContainer.querySelector('#marker-wrapper');
            if (!wrapper) return;
            wrapper.querySelectorAll('.ref-marker').forEach(el => el.remove());
            for (const turnIndex in allTurnsNotes) {
                const notes = allTurnsNotes[turnIndex];
                for (const type in MARKER_CONFIG) {
                    if (notes[type] && notes[type].x !== undefined) {
                        createRefMarker(type, notes[type], parseInt(turnIndex) === selectedTurnIndex);
                    }
                }
            }
        }

        function createRefMarker(type, data, isActive) {
            const config = MARKER_CONFIG[type];
            const marker = document.createElement('div');
            marker.className = 'ref-marker';
            marker.dataset.reftype = type;
            marker.style.left = `${data.x}%`;
            marker.style.top = `${data.y}%`;
            
            let color = config.defaultColor;
            if (type === 'braking' && data.intensity) {
                color = config.colors[data.intensity] || config.defaultColor;
            }
            marker.classList.add(color);

            if (!isActive && !isGlobalView) {
                marker.classList.add('opacity-30');
            }

            if (type === 'gear' && data.gear) {
                marker.innerHTML = `<span class="text-base">${data.gear}</span>`;
            } else {
                marker.innerHTML = `<i class="fa-solid ${config.icon}"></i>`;
            }
            
            marker.onclick = (e) => { e.stopPropagation(); isGlobalView ? showNoteTooltip(e, type, data) : openValueSelectionModal(type); };
            marker.onmousedown = (e) => { e.stopPropagation(); startDrag(e, marker); };
            marker.ontouchstart = (e) => { e.stopPropagation(); startDrag(e, marker); };

            DOMElements.mapImageContainer.querySelector('#marker-wrapper').appendChild(marker);
        }

        function openValueSelectionModal(type) {
            const currentTurnNotes = allTurnsNotes[selectedTurnIndex] || { circuitId: currentCircuitId, turnIndex: selectedTurnIndex, userId: userId };
            placingData = currentTurnNotes[type] ? { type, ...currentTurnNotes[type] } : placingData;
            if (!placingData) return;

            selectedRefType = type;
            const config = MARKER_CONFIG[type];
            DOMElements.valueModalTitle.textContent = config.title;
            DOMElements.valueModalOptions.innerHTML = '';
            DOMElements.valueModal.classList.remove('hidden');
            DOMElements.markerNotes.value = placingData.notes || '';

            const options = type === 'braking' ? Object.keys(config.colors) : (config.values || []);
            if (options.length > 0) {
                const selector = document.createElement('div');
                selector.className = 'space-y-2';
                const values = type === 'gear' ? Array.from({length: 6}, (_, i) => i + 1) : options;

                values.forEach(val => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full touch-button text-lg';
                    btn.textContent = val;
                    btn.onclick = () => onValueSelected({ [type === 'braking' ? 'intensity' : type === 'throttleOn' ? 'throttleOn' : 'gear']: val });
                    selector.appendChild(btn);
                });
                DOMElements.valueModalOptions.appendChild(selector);
            }
        }

        function onValueSelected(data) {
            const type = placingData.type;
            const notes = allTurnsNotes[selectedTurnIndex] || { circuitId: currentCircuitId, turnIndex: selectedTurnIndex, userId: userId };
            notes[type] = { ...placingData, ...data, notes: DOMElements.markerNotes.value };
            saveTurnNotes(selectedTurnIndex, notes).then(() => {
                DOMElements.valueModal.classList.add('hidden');
                placingData = null;
            });
        }

        function initEventHandlers() {
            DOMElements.circuitSelector.onchange = (e) => selectCircuit(e.target.value);
            DOMElements.prevTurnBtn.onclick = () => selectTurn(selectedTurnIndex > 0 ? selectedTurnIndex - 1 : currentCircuitData.turns.length - 1);
            DOMElements.nextTurnBtn.onclick = () => selectTurn((selectedTurnIndex + 1) % currentCircuitData.turns.length);
            DOMElements.generalNotes.onchange = () => {
                const notes = allTurnsNotes[selectedTurnIndex] || { circuitId: currentCircuitId, turnIndex: selectedTurnIndex, userId: userId };
                notes.generalNotes = DOMElements.generalNotes.value;
                saveTurnNotes(selectedTurnIndex, notes);
            };

            document.querySelectorAll('.add-ref-btn').forEach(btn => {
                btn.onclick = () => {
                    if (selectedTurnIndex === -1) {
                        alert("Veuillez d'abord sélectionner un virage.");
                        return;
                    }
                    placingData = { type: btn.dataset.reftype };
                    DOMElements.placingIndicator.classList.remove('hidden');
                };
            });

            DOMElements.mapImageContainer.onclick = (e) => {
                if (placingData) {
                    const wrapper = DOMElements.mapImageContainer.querySelector('#marker-wrapper');
                    if (!wrapper || !wrapper.contains(e.target)) return;

                    const rect = wrapper.getBoundingClientRect();
                    placingData.x = ((e.clientX - rect.left) / rect.width) * 100;
                    placingData.y = ((e.clientY - rect.top) / rect.height) * 100;
                    
                    const type = placingData.type;
                    const notes = allTurnsNotes[selectedTurnIndex] || { circuitId: currentCircuitId, turnIndex: selectedTurnIndex, userId: userId };
                    
                    if (type === 'braking' || type === 'gear' || type === 'throttleOn') {
                        openValueSelectionModal(type);
                    } else {
                        notes[type] = { ...placingData };
                        saveTurnNotes(selectedTurnIndex, notes);
                        placingData = null;
                    }
                    DOMElements.placingIndicator.classList.add('hidden');
                } else {
                     DOMElements.noteTooltip.classList.add('hidden');
                }
            };

            DOMElements.valueModalCancel.onclick = () => {
                DOMElements.valueModal.classList.add('hidden');
                placingData = null;
            };
            DOMElements.valueModalDelete.onclick = () => {
                if (selectedRefType) {
                    const notes = allTurnsNotes[selectedTurnIndex];
                    if(notes) {
                        delete notes[selectedRefType];
                        saveTurnNotes(selectedTurnIndex, notes);
                    }
                    DOMElements.valueModal.classList.add('hidden');
                    selectedRefType = null;
                }
            };
            DOMElements.deleteTurnBtn.onclick = () => {
                if (confirm("Êtes-vous sûr de vouloir supprimer tous les repères de ce virage ?")) {
                    const noteToKeep = {
                        circuitId: currentCircuitId, turnIndex: selectedTurnIndex, userId: userId, generalNotes: DOMElements.generalNotes.value
                    };
                    saveTurnNotes(selectedTurnIndex, noteToKeep);
                }
            };

            let modalTurns = [];
            DOMElements.newCircuitBtn.onclick = () => {
                DOMElements.newCircuitModal.classList.remove('hidden');
                DOMElements.circuitName.value = '';
                DOMElements.circuitImage.value = '';
                DOMElements.modalTurnDef.classList.add('hidden');
                DOMElements.imagePreview.src = '';
                DOMElements.modalError.textContent = '';
                modalTurns = [];
            };
            DOMElements.modalCancel.onclick = () => DOMElements.newCircuitModal.classList.add('hidden');
            DOMElements.circuitImage.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        DOMElements.imagePreview.src = event.target.result;
                        DOMElements.modalTurnDef.classList.remove('hidden');
                        DOMElements.previewDotsContainer.innerHTML = '';
                        modalTurns = [];
                        DOMElements.turnCount.textContent = '0';
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            const handleDotPlacement = (e) => {
                e.preventDefault();
                if (e.target.classList.contains('turn-marker')) return;
                const rect = e.currentTarget.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const x = ((clientX - rect.left) / rect.width) * 100;
                const y = ((clientY - rect.top) / rect.height) * 100;
                modalTurns.push({ x, y });
                const dot = document.createElement('div');
                dot.className = 'turn-marker';
                dot.textContent = modalTurns.length;
                dot.style.left = `${x}%`;
                dot.style.top = `${y}%`;
                DOMElements.previewDotsContainer.appendChild(dot);
                DOMElements.turnCount.textContent = modalTurns.length;
            };

            DOMElements.previewContainer.onclick = handleDotPlacement;
            DOMElements.previewContainer.ontouchstart = handleDotPlacement;

            DOMElements.modalSave.onclick = async () => {
                DOMElements.modalError.textContent = '';
                const name = DOMElements.circuitName.value.trim();
                const modalImageFile = DOMElements.circuitImage.files[0];
                if (!name || !modalImageFile || modalTurns.length === 0) {
                    DOMElements.modalError.textContent = "Veuillez remplir tous les champs et définir au moins un virage.";
                    return;
                }
                if (!auth.currentUser) {
                    DOMElements.modalError.textContent = "Erreur d'authentification. Veuillez rafraîchir la page.";
                    return;
                }
                const currentUserId = auth.currentUser.uid;
                DOMElements.modalSave.disabled = true;
                DOMElements.modalSave.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Sauvegarde...';
                try {
                    const imagePath = `circuits/${currentUserId}/${Date.now()}_${modalImageFile.name}`;
                    const imageRef = ref(storage, imagePath);
                    await uploadBytes(imageRef, modalImageFile);
                    const imageUrl = await getDownloadURL(imageRef);
                    const newCircuit = { userId: currentUserId, name, imageUrl, turns: modalTurns };
                    const docRef = await addDoc(collection(db, "circuits"), newCircuit);
                    DOMElements.newCircuitModal.classList.add('hidden');
                    DOMElements.circuitSelector.value = docRef.id;
                    selectCircuit(docRef.id);
                } catch (error) {
                    console.error("Error saving circuit:", error);
                    DOMElements.modalError.textContent = "Erreur: " + error.code;
                } finally {
                    DOMElements.modalSave.disabled = false;
                    DOMElements.modalSave.innerHTML = 'Sauvegarder';
                }
            };

            DOMElements.globalViewToggle.onchange = () => {
                isGlobalView = DOMElements.globalViewToggle.checked;
                drawAllReferenceMarkers();
            };

            DOMElements.summaryBtn.onclick = () => generateSummary();
            DOMElements.summaryModalClose.onclick = () => DOMElements.summaryModal.classList.add('hidden');
        }

        function startDrag(e, marker) {
            e.preventDefault();
            draggingMarker = {
                element: marker,
                type: marker.dataset.type,
                reftype: marker.dataset.reftype,
                index: marker.dataset.index
            };
            marker.style.cursor = 'grabbing';
            document.body.style.cursor = 'grabbing';
            
            const moveHandler = (event) => drag(event);
            const endHandler = (event) => stopDrag(event);

            DOMElements.mapImageContainer.addEventListener('mousemove', moveHandler);
            DOMElements.mapImageContainer.addEventListener('touchmove', moveHandler, { passive: false });
            window.addEventListener('mouseup', endHandler);
            window.addEventListener('touchend', endHandler);
        }

        function drag(e) {
            if (!draggingMarker) return;
            e.preventDefault();
            const wrapper = DOMElements.mapImageContainer.querySelector('#marker-wrapper');
            const rect = wrapper.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            let x = ((clientX - rect.left) / rect.width) * 100;
            let y = ((clientY - rect.top) / rect.height) * 100;
            x = Math.max(0, Math.min(100, x));
            y = Math.max(0, Math.min(100, y));
            draggingMarker.element.style.left = `${x}%`;
            draggingMarker.element.style.top = `${y}%`;
        }

        function stopDrag(e) {
            if (!draggingMarker) return;
            const wrapper = DOMElements.mapImageContainer.querySelector('#marker-wrapper');
            const rect = wrapper.getBoundingClientRect();
            const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
            const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            let x = ((clientX - rect.left) / rect.width) * 100;
            let y = ((clientY - rect.top) / rect.height) * 100;
            x = Math.max(0, Math.min(100, x));
            y = Math.max(0, Math.min(100, y));

            if (draggingMarker.type === 'turn') {
                currentCircuitData.turns[draggingMarker.index].x = x;
                currentCircuitData.turns[draggingMarker.index].y = y;
                updateCircuitData();
            } else {
                const notes = allTurnsNotes[selectedTurnIndex];
                if(notes && notes[draggingMarker.reftype]) {
                    notes[draggingMarker.reftype].x = x;
                    notes[draggingMarker.reftype].y = y;
                    saveTurnNotes(selectedTurnIndex, notes);
                }
            }

            draggingMarker.element.style.cursor = 'grab';
            document.body.style.cursor = 'default';
            
            DOMElements.mapImageContainer.removeEventListener('mousemove', drag);
            DOMElements.mapImageContainer.removeEventListener('touchmove', drag);
            window.removeEventListener('mouseup', stopDrag);
            window.removeEventListener('touchend', stopDrag);
            draggingMarker = null;
        }

        function showNoteTooltip(e, type, data) {
            if (!data.notes) return;
            DOMElements.noteTooltip.textContent = data.notes;
            DOMElements.noteTooltip.style.left = `${e.clientX}px`;
            DOMElements.noteTooltip.style.top = `${e.clientY}px`;
            DOMElements.noteTooltip.classList.remove('hidden');
        }

        function generateSummary() {
            DOMElements.summaryContent.innerHTML = '';
            for(let i=0; i < currentCircuitData.turns.length; i++) {
                const turnNotes = allTurnsNotes[i];
                if(!turnNotes) continue;

                const turnDiv = document.createElement('div');
                turnDiv.className = 'p-4 bg-gray-700 rounded-lg';
                
                const turnTitle = document.createElement('h4');
                turnTitle.className = 'text-xl font-bold mb-2 text-blue-400';
                turnTitle.textContent = `Virage ${i + 1}`;
                turnDiv.appendChild(turnTitle);

                if(turnNotes.generalNotes) {
                    const p = document.createElement('p');
                    p.className = 'italic text-gray-300 mb-3';
                    p.textContent = turnNotes.generalNotes;
                    turnDiv.appendChild(p);
                }
                
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 gap-3';

                for(const type in MARKER_CONFIG) {
                    if(turnNotes[type]) {
                        const data = turnNotes[type];
                        const config = MARKER_CONFIG[type];
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex items-start space-x-3';
                        const icon = document.createElement('i');
                        icon.className = `fa-solid ${config.icon} mt-1`;
                        
                        const textDiv = document.createElement('div');
                        let value = data.intensity || data.gear || data.throttleOn || '';
                        textDiv.innerHTML = `<strong class="font-semibold">${config.name}:</strong> ${value}`;
                        if(data.notes) {
                            textDiv.innerHTML += `<p class="text-sm text-gray-400 pl-1">- ${data.notes}</p>`;
                        }
                        
                        itemDiv.append(icon, textDiv);
                        grid.appendChild(itemDiv);
                    }
                }
                turnDiv.appendChild(grid);
                DOMElements.summaryContent.appendChild(turnDiv);
            }
            DOMElements.summaryModal.classList.remove('hidden');
        }

    </script>
</body>
</html>
